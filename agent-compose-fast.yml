services:
  ai-agent:
    image: node:18
    working_dir: /workspace
    volumes:
      - ${WORKTREE_PATH:-./}:/workspace:rw
      - ${CONTEXT_PATH:-./.context}:/context:ro
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - WORKSPACE=/workspace
      - ISSUE_NUMBER=${ISSUE_NUMBER:-2}
      - GITHUB_KEY=${GITHUB_KEY:-}
      - TASK_MSG=${TASK_MSG:-}
    command:
      - bash
      - -c
      - |
        # Use task from environment variable or create default
        if [ -n "$$TASK_MSG" ]; then
          echo "‚úÖ Task from environment variable:"
          echo "üìÑ TASK_MSG: [$$TASK_MSG]"
        elif [ -f "/context/task.txt" ]; then
          echo "‚úÖ Task file found, reading content:"
          echo "üìÑ RAW FILE CONTENT:"
          cat /context/task.txt
          echo ""
          TASK_MSG=$$(cat /context/task.txt)
          echo "üìÑ VARIABLE CONTENT: [$$TASK_MSG]"
        else
          echo "‚ö†Ô∏è No task specified, using default task"
          TASK_MSG="Modify some random file adding a comment and commit the changes and push it to the repo as a new pr, Commit your changes with conventional commits referencing #2"
        fi
        
        # Install GitHub CLI and curl
        apt-get update && apt-get install -y gh curl
        
        # Configure Git with safe directories first
        git config --global --add safe.directory /workspace
        git config --global --add safe.directory '*'
        git config --global user.name "AI Agent"
        git config --global user.email "ai-agent@americanservices.tech"
        
        # Setup GitHub CLI authentication 
        echo "$GITHUB_KEY" | gh auth login --with-token
        echo "üîê GitHub authentication test:"
        gh auth status || echo "‚ö†Ô∏è GitHub CLI auth failed"
        
        # Configure git to use GitHub CLI for authentication
        gh auth setup-git
        
        # Debug: show current environment
        cd /workspace
        echo "üîç DEBUG: Current environment and git setup"
        echo "Current directory: $(pwd)"
        echo "Contents:"
        ls -la
        echo "Git status:"
        if [ -f .git ]; then
          echo ".git is a FILE (worktree pointer):"
          cat .git
        elif [ -d .git ]; then
          echo ".git is a DIRECTORY"
          ls -la .git/
        else
          echo ".git does not exist"
        fi
        echo "Environment variables:"
        echo "  WORKTREE_PATH: ${WORKTREE_PATH:-not_set}"
        echo "  CONTEXT_PATH: ${CONTEXT_PATH:-not_set}"  
        echo "  ISSUE_NUMBER: ${ISSUE_NUMBER:-not_set}"
        echo "  GITHUB_TOKEN: ${GITHUB_TOKEN:-not_set}"
        echo ""
        
        echo "üîß Fixing git setup for container..."
        
        # Skip git initialization - use the worktree as-is with existing history
        git config --global --add safe.directory /workspace
        
        echo "üîó Verifying git remote..."
        git remote -v || echo "No remotes found"
        
        echo "üîç Checking current git status..."
        git status || echo "Git status failed"
        git branch -a || echo "Branch listing failed"
        
        echo "‚úÖ Git repository ready"
        
        echo ""
        echo "üöÄ Starting Claude with task..."
        echo "üìÑ Task: $$TASK_MSG"
        echo ""
        
        # Since we can't use Claude Code with --dangerously-skip-permissions as root,
        # we'll implement the task directly with git commands for autonomous operation
        echo "ü§ñ Implementing task autonomously..."
        
        # Ensure git user is configured before any git operations
        git config user.name "AI Agent"
        git config user.email "ai-agent@americanservices.tech"
        echo "‚úÖ Git user configured"
        
        # Get current branch name to preserve it
        ORIGINAL_BRANCH=$(git branch --show-current 2>/dev/null || echo "master")
        echo "üîç DEBUG: Issue number from environment: [$${ISSUE_NUMBER:-EMPTY}]"
        echo "üîç DEBUG: Original branch: $$ORIGINAL_BRANCH"
        
        # Create proper branch name based on issue
        BRANCH_NAME="fix/issue-$${ISSUE_NUMBER:-2}-autonomous"
        echo "üîç DEBUG: Target branch: $$BRANCH_NAME"
        
        # Always create/recreate branch from master to ensure common history
        echo "üîÑ Creating/recreating $$BRANCH_NAME from master..."
        git checkout -B "$$BRANCH_NAME" origin/master
        echo "‚úÖ Branch created from master base"
        
        # Mock implementation: modify a file
        echo "# Added by AI Agent for autonomous testing - $(date)" >> test.md
        echo "‚úÖ Modified test.md with comment"
        
        # Stage all changes (worktree files + our modification)
        git add .
        echo "‚úÖ Staged all changes"
        
        # Create commit with conventional commit format
        git commit -m "feat: implement changes for issue #$${ISSUE_NUMBER:-2}

        ü§ñ Generated with Claude Code
        
        Co-Authored-By: Claude <noreply@anthropic.com>"
        echo "‚úÖ Created commit"
        
        # Try git push now that gh auth setup-git was run
        echo "üì§ Pushing branch with git (using gh credentials)..."
        git push --set-upstream origin "$$BRANCH_NAME" 2>&1 && echo "‚úÖ Push successful" || echo "‚ùå Push failed"
        
        # Create PR
        echo "üìã Creating pull request..."
        gh repo set-default americanservices/factory_floor
        gh pr create --title "feat: implement changes for issue #$${ISSUE_NUMBER:-2}" --body "Automated PR created by AI agent to resolve issue #$${ISSUE_NUMBER:-2}." --head "$$BRANCH_NAME" --base master --repo americanservices/factory_floor 2>&1 && echo "‚úÖ PR created successfully" || echo "‚ùå PR creation failed"
        
        echo "‚úÖ Workflow completed"
        
        echo "üîó Checking if PR was created..."
        gh pr list --head "$$BRANCH_NAME" 2>&1 || echo "‚ùå No PR found for this branch"
        
        echo "‚úÖ Autonomous workflow completed"
    stdin_open: false
    tty: false